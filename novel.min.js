var InputManager,InventoryManager,NovelManager,Parser,SceneManager,SoundManager,TextPrinter,UI,Util,copyButton,inputManager,inventoryManager,novelArea,novelData,novelManager,novelPath,parser,sceneManager,soundManager,textPrinter,ui,util,indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};NovelManager=function(){function e(){}return e.prototype.loadCookie=function(e){var t,n,r,s;for(s=e+"=",n=document.cookie.split(";"),r=0;r<n.length;){for(t=n[r];" "===t.charAt(0);)t=t.substring(1);if(0===t.indexOf(s))return t.substring(s.length,t.length);r++}return""},e.prototype.saveCookie=function(e,t,n){var r,s;return r=new Date,r.setTime(r.getTime()+24*n*60*60*1e3),s="expires="+r.toUTCString(),document.cookie=e+"="+t+"; "+s+"; path=/"},e.prototype.loadData=function(e,t){var n,r;if(void 0===t&&(t=!0),void 0===e){if(""!==this.loadCookie("gameData"))return console.log("Cookie found!"),n=this.loadCookie("gameData"),console.log("Cookie loaded"),console.log(n),r=JSON.parse(atob(this.loadCookie("gameData"))),this.prepareLoadedData(r,t)}else if(void 0!==e)return r=JSON.parse(atob(e)),this.prepareLoadedData(r,t)},e.prototype.prepareLoadedData=function(e,t){return novelData.novel.name!==e.name?void console.error("ERROR! novel name mismatch"):(novelData.novel.version!==e.version&&console.warn("WARNING! novel version mismatch"),novelData.novel.inventories=e.inventories,novelData.debugMode=novelData.novel.debugMode,soundManager.init(),t?sceneManager.updateScene(e.currentScene,!0):void 0)},e.prototype.start=function(){var e;return e=new XMLHttpRequest,e.open("GET",novelPath+"/novel.json",!0),e.onload=function(){var t;return e.status>=200&&e.status<400?(t=JSON.parse(e.responseText),t=novelManager.prepareData(t),novelData.novel=t,novelData.novel.currentScene=sceneManager.changeScene(novelData.novel.scenes[0].name),novelData.debugMode=novelData.novel.debugMode,soundManager.init()):void 0},e.onerror=function(){},e.send(),null!==document.querySelector("#continue-button")?document.querySelector("#continue-button").style.display="none":void 0},e.prototype.saveDataAsJson=function(){var e,t;return t=JSON.parse(JSON.stringify(novelData.novel)),delete t.scenes,delete t.tagPresets,delete t.sounds,e=btoa(JSON.stringify(t))},e.prototype.saveData=function(){var e;return e=this.saveDataAsJson(),"cookie"===novelData.novel.settings.saveMode?this.saveCookie("novelData",e,365):"text"===novelData.novel.settings.saveMode?ui.showSaveNotification(e):void 0},e.prototype.prepareData=function(e){var t,n,r,s,a,o,i,l,u,p,c,d,v,f,h;for(e.currentScene="",e.parsedChoices="",void 0===e.currentInventory&&(e.currentInventory=0),void 0===e.inventories&&(e.inventories=[]),void 0===e.scenes&&(e.scenes=[]),d=e.inventories,s=0,o=d.length;o>s;s++)for(n=d[s],a=0,i=n.length;i>a;a++)r=n[a],void 0===r.displayName&&(r.displayName=r.name);for(v=e.scenes,p=0,l=v.length;l>p;p++)for(h=v[p],h.combinedText="",h.parsedText="",void 0===h.text&&(console.warn("WARNING! scene "+h.name+" has no text"),h.text=""),void 0===h.choices&&(console.warn("WARNING! scene "+h.name+" has no choices"),h.choices=[]),f=h.choices,c=0,u=f.length;u>c;c++)t=f[c],t.parsedText="",void 0===t.alwaysShow&&(t.alwaysShow=!1);return e},e}(),InputManager=function(){function e(){}return e.prototype.presses=0,e.prototype.keyDown=function(e){return this.formsSelected()?void 0:13===e||32===e?(novelData.novel.settings.scrollSettings.continueWithKeyboard&&sceneManager.tryContinue(),novelData.novel.settings.scrollSettings.skipWithKeyboard&&textPrinter.trySkip(),textPrinter.unpause()):void 0},e.prototype.keyPressed=function(e){return this.formsSelected()?void 0:(this.presses++,(13===e||32===e)&&this.presses>2&&novelData.novel.settings.scrollSettings.fastScrollWithKeyboard?textPrinter.fastScroll():void 0)},e.prototype.keyUp=function(e){return this.formsSelected()?void 0:(this.presses=0,13===e||32===e?textPrinter.stopFastScroll():void 0)},e.prototype.formsSelected=function(){var e,t,n,r;for(t=document.getElementById("novel-area").querySelectorAll("input"),n=0,r=t.length;r>n;n++)if(e=t[n],e===document.activeElement)return!0;return!1},e}(),document.onkeydown=function(e){var t;return e=e||window.event,t=e.keyCode||e.which,inputManager.keyDown(t)},document.onkeypress=function(e){var t;return e=e||window.event,t=e.keyCode||e.which,inputManager.keyPressed(t)},document.onkeyup=function(e){var t;return e=e||window.event,t=e.keyCode||e.which,inputManager.keyUp(t)},Parser=function(){function Parser(){}return Parser.prototype.selectRandomOption=function(e){var t,n,r,s,a;if(util.checkFormat(e,"string"),a=e.split("|"),1===a.length)return a[0];for(s=[],n=0,r=a.length;r>n;n++)t=a[n],t=t.split(","),s.push(t);return s=this.chooseRandomly(s)},Parser.prototype.chooseRandomly=function(e){var t,n,r,s,a,o,i,l,u,p,c,d,v,f;for(u=[],t=[],d=[],c=0,r=0,a=e.length;a>r;r++)n=e[r],u.push(n[0]),c=parseFloat(n[1])+c,t.push(c),d.push(parseFloat(n[1]));for(v=0,s=0,o=d.length;o>s;s++)n=d[s],v+=parseFloat(n);for(1!==v&&console.error("ERROR: Invalid scene or choice odds (should add up to exactly 1)!"),f=Math.random(),l=0,p=0,i=t.length;i>p;p++){if(n=t[p],n>f)return u[l];l++}},Parser.prototype.parseItems=function(e){var t,n,r,s,a;if(util.checkFormat(e,"string"),""!==e){for(a=e.split("|"),s=[],n=0,r=a.length;r>n;n++)t=a[n],t=t.split(","),s.push(t);return s}},Parser.prototype.parseText=function(e){var t,n,r,s,a,o,i,l,u,p,c,d,v,f,h,g,m,y,S,x,M,D,k,T,b;if(void 0!==e){for(util.checkFormat(e,"string"),h=novelData.novel.tagPresets,s=0,o=h.length;o>s;s++)n=h[s],k="[p "+n.name+"]",e.indexOf(k)>-1&&(e=e.split(k).join(n.start)),k="[/p "+n.name+"]",e.indexOf(k)>-1&&(e=e.split(k).join(n.end));for(n=a=0;99>=a;n=++a)e=e.split("[s"+n+"]").join('<span class="highlight-'+n+'">');for(e=e.split("[/s]").join("</span>"),e=e.replace(/\/\[/g,"OPEN_BRACKET_REPLACEMENT").replace(/\/\]/g,"CLOSE_BRACKET_REPLACEMENT"),M=e.split(/\[|\]/),r=0,c=0,i=M.length;i>c;c++)S=M[c],M[r]=S.replace(/OPEN_BRACKET_REPLACEMENT/g,"[").replace(/CLOSE_BRACKET_REPLACEMENT/g,"]"),r++;for(x=0,t=0,r=0,r=f=0,g=M.length-1;g>=0?g>=f:f>=g;r=g>=0?++f:--f){if(S=M[r],"if"===S.substring(0,2))v=S.split("if "),this.parseStatement(v[1])?M[r]="":(M[r]='<span style="display:none;">',x++);else if("/if"===S.substring(0,3))x>0?(M[r]="</span>",x--):M[r]="";else if("inv."===S.substring(0,4))for(b=S.substring(4,S.length),M[r]=0,m=novelData.novel.inventories[novelData.novel.currentInventory],D=0,l=m.length;l>D;D++)n=m[D],n.name===b&&(M[r]=n.value);else if("print"===S.substring(0,5))v=S.split("print "),v=this.parseStatement(v[1]),isNaN(parseFloat(v))||(v=parseFloat(v.toFixed(novelData.novel.settings.floatPrecision))),M[r]=v;else if("exec"===S.substring(0,4))v=S.substring(5,S.length),d=novelData.parsedJavascriptCommands.push(v),d--,M[r]='<span class="execute-command com-'+d+'"></span>';else if("pause"===S.substring(0,5))v=S.substring(6,S.length),M[r]='<span class="pause '+v+'"></span>';else if("sound"===S.substring(0,5))v=S.split("sound "),M[r]='<span class="play-sound '+v[1]+'"></span>';else if("stopMusic"===S.substring(0,9))v=S.split("stopMusic "),M[r]='<span class="stop-music '+v[1]+'"></span>';else if("music"===S.substring(0,5))v=S.split("music "),M[r]='<span class="play-music '+v[1]+'"></span>';else if("/speed"===S.substring(0,6))M[r]='<span class="default-speed"></span>';else if("speed"===S.substring(0,5))v=S.split("speed "),M[r]='<span class="set-speed '+v[1]+'"></span>';else if("/scrollSound"===S.substring(0,12))M[r]='<span class="default-scroll-sound"></span>';else if("scrollSound"===S.substring(0,11))v=S.split("scrollSound "),M[r]='<span class="set-scroll-sound '+v[1]+'"></span>';else if("input"===S.substring(0,5)){for(v=S.split("input "),p="",y=novelData.novel.inventories[novelData.novel.currentInventory],T=0,u=y.length;u>T;T++)n=y[T],n.name===v[1]&&(p=n.value);M[r]='<input type="text" value="'+p+'" name="input" class="input-'+v[1]+'" onblur="ui.updateInputs(true)">'}else"choice"===S.substring(0,6)?(v=S.split("choice "),M[r]='<a href="#" onclick="sceneManager.selectChoiceByNameByClicking(event,\''+v[1]+"')\">",t++):"/choice"===S.substring(0,7)&&(t>0?(M[r]="</a>",t--):M[r]="");r++}return e=M.join("")}},Parser.prototype.parseStatement=function(s){var found,i,k,l,len,len1,o,parsedString,parsedValues,plus,ref,ref1,result,type,val,vals;if(void 0!==s){for(s=s.toString(),util.checkFormat(s,"string"),util.validateParentheses(s)||console.error("ERROR: Invalid parentheses in statement"),s=s.replace(/\s+/g,""),parsedString=s.split(/\(|\)|\+|\*|\-|\/|<=|>=|<|>|==|!=|\|\||&&/),parsedValues=[],k=0,len=parsedString.length;len>k;k++)switch(val=parsedString[k],type=this.getStatementType(val)){case"item":for(found=!1,ref=novelData.novel.inventories[novelData.novel.currentInventory],l=0,len1=ref.length;len1>l;l++)i=ref[l],i.name===val.substring(4,val.length)&&(parsedValues.push(i.value),found=!0);found||parsedValues.push(0);break;case"rand":val=val.split("."),vals=val[1].split(","),plus=!0,"minus"===vals[0].substring(0,5)&&(vals[0]=vals[0].substring(5,vals[0].length),plus=!1),"minus"===vals[1].substring(0,5)&&(vals[1]=vals[1].substring(5,vals[1].length),plus=!1),result=plus?Math.random()*vals[1]+vals[0]:Math.random()*vals[1]-vals[0],void 0===vals[2]&&(vals[2]=0),result=0===vals[2]?Math.round(result):parseFloat(result).toFixed(vals[2]),parsedValues.push(result);break;case"var":val=this.findValue(val.substring(4,val.length),!0),isNaN(parseFloat(val))?parsedValues.push("'"+val+"'"):parsedValues.push(parseFloat(val).toFixed(novelData.novel.settings.floatPrecision));break;case"float":parsedValues.push(parseFloat(val).toFixed(novelData.novel.settings.floatPrecision));break;case"int":parsedValues.push(parseInt(val));break;case"string":""!==val?parsedValues.push("'"+val+"'"):parsedValues.push("")}for(i=o=0,ref1=parsedString.length-1;ref1>=0?ref1>=o:o>=ref1;i=ref1>=0?++o:--o)""!==parsedString[i]&&""!==parsedValues[i]&&(parsedString[i]=parsedString[i].replace("{","{"),parsedString[i]=parsedString[i].replace("}","}"),s=s.replace(new RegExp(parsedString[i],"g"),parsedValues[i]));return eval(s)}},Parser.prototype.getStatementType=function(e){var t;return t=null,t="inv."===e.substring(0,4)?"item":"var."===e.substring(0,4)?"var":"rand."===e.substring(0,5)?"rand":isNaN(parseFloat(e))||-1!==e.toString().indexOf(".")?isNaN(parseFloat(e))||-1===e.toString().indexOf(".")?"string":"float":"int"},Parser.prototype.findValue=function(e,t){var n,r,s,a,o;for(a=e.split(","),o=t?this.findValueByName(novelData.novel,a[0])[0]:a.length>1?this.findValueByName(novelData.novel,a[0])[0]:this.findValueByName(novelData.novel,a[0])[1],n=r=0,s=a.length-1;s>=0?s>=r:r>=s;n=s>=0?++r:--r)util.isOdd(n)?o=o[parseInt(a[n])]:0!==n&&(t?("parsedText"!==a[n]&&"text"!==a[n]||(a[n]="parsedText",o.parsedText=this.parseText(o.text)),o=this.findValueByName(o,a[n])[0]):o=this.findValueByName(o,a[n])[1]);return void 0===o&&console.warn("WARNING: Searched value not found."),o},Parser.prototype.findValueByName=function(e,t){var n,r,s,a;return util.checkFormat(t,"string"),s=t.split("."),n=e[s[0]],s[1]?(s.splice(0,1),r=s.join("."),this.findValueByName(n,r)):(a=[],a[0]=n,a[1]=e,a)},Parser}(),InventoryManager=function(){function e(){}return e.prototype.checkRequirements=function(e){var t,n,r,s,a,o,i,l;for(util.checkFormat(e,"array"),l=0,i=novelData.novel.inventories[novelData.novel.currentInventory],r=0,a=i.length;a>r;r++)for(t=i[r],s=0,o=e.length;o>s;s++)n=e[s],n[0]===t.name&&n[1]<=t.value&&(l+=1);return l===e.length},e.prototype.setValue=function(e,t){var n,r;return util.checkFormat(e,"string"),n=this.getValueArrayLast(e),r=parser.findValue(e,!1),r[n]=t},e.prototype.increaseValue=function(e,t){var n,r;return util.checkFormat(e,"string"),n=this.getValueArrayLast(e),r=parser.findValue(e,!1),r[n]=r[n]+t,isNaN(parseFloat(r[n]))?void 0:r[n]=parseFloat(r[n].toFixed(novelData.novel.settings.floatPrecision))},e.prototype.decreaseValue=function(e,t){var n,r;return util.checkFormat(e,"string"),n=this.getValueArrayLast(e),r=parser.findValue(e,!1),r[n]=r[n]-t,isNaN(parseFloat(r[n]))?void 0:r[n]=parseFloat(r[n].toFixed(novelData.novel.settings.floatPrecision))},e.prototype.getValueArrayLast=function(e){var t;return t=e.split(","),t=t[t.length-1].split("."),t=t[t.length-1]},e.prototype.editItems=function(e,t){var n,r,s,a,o,i,l,u,p,c,d,v,f,h;for(util.checkFormat(e,"array"),f=[],i=0,u=e.length;u>i;i++){for(o=e[i],r=!1,"!"===o[0].substring(0,1)&&(r=!0,o[0]=o[0].substring(1,o[0].length)),a=!1,v=novelData.novel.inventories[novelData.novel.currentInventory],l=0,p=v.length;p>l;l++)s=v[l],s.name===o[0]&&(c=1,o.length>2?(n=o[2],h=parseInt(parser.parseStatement(o[1])),isNaN(n)||(c=o[2],n=o.name),o.length>3&&(c=parseFloat(o[2]),n=o[3])):(n=o[0],h=parseInt(parser.parseStatement(o[1]))),d=Math.random(),c>d&&("set"===t?isNaN(parseInt(o[1]))?s.value=o[1]:s.value=parseInt(o[1]):"add"===t?(isNaN(parseInt(s.value))&&(s.value=0),s.value=parseInt(s.value)+h):"remove"===t&&(isNaN(parseInt(s.value))?s.value=0:(s.value=parseInt(s.value)-h,s.value<0&&(s.value=0)))),a=!0);a||"remove"===t?f.push(void 0):(c=1,h=parseInt(parser.parseStatement(o[1])),isNaN(h)&&(h=parser.parseStatement(o[1])),o.length>2?(n=o[2],isNaN(n)||(c=o[2],n=o.name),o.length>3&&(c=parseFloat(o[2]),n=o[3])):n=o[0],d=Math.random(),void 0===n&&(n=o[0]),c>d?f.push(novelData.novel.inventories[novelData.novel.currentInventory].push({name:o[0],value:h,displayName:n,hidden:r})):f.push(void 0))}return f},e}(),SceneManager=function(){function SceneManager(){}return SceneManager.prototype.tryContinue=function(){return textPrinter.printCompleted&&1===textPrinter.tickSpeedMultiplier?this.selectChoiceByName("Continue"):void 0},SceneManager.prototype.selectChoice=function(e){return this.exitScene(novelData.novel.currentScene),this.readItemEdits(e),this.readSounds(e,!0),this.readSaving(e),this.readExecutes(e),this.readCheckpoints(e),void 0!==e.nextScene?this.changeScene(e.nextScene):void 0!==e.nextChoice?this.selectChoiceByName(parser.selectRandomOption(e.nextChoice)):this.updateScene(novelData.novel.currentScene,!0)},SceneManager.prototype.selectChoiceByNameByClicking=function(e,t){return e.stopPropagation(),e.preventDefault(),this.selectChoiceByName(t)},SceneManager.prototype.selectChoiceByName=function(e){var t,n,r,s,a;for(s=novelData.novel.currentScene.choices,a=[],n=0,r=s.length;r>n;n++){if(t=s[n],t.name===e){novelArea.selectChoice(t);break}a.push(void 0)}return a},SceneManager.prototype.exitScene=function(e){return ui.updateInputs(!1)},SceneManager.prototype.changeScene=function(e){var t;return util.checkFormat(e,"string"),t=this.findSceneByName(parser.selectRandomOption(e)),this.setupScene(t),t},SceneManager.prototype.setupScene=function(e){return this.updateScene(e,!1),this.readItemEdits(novelData.novel.currentScene),this.readSounds(novelData.novel.currentScene,!1),this.readSaving(novelData.novel.currentScene),this.readExecutes(novelData.novel.currentScene),this.readCheckpoints(novelData.novel.currentScene),this.readMisc(novelData.novel.currentScene),textPrinter.printText(e.parsedText,!1)},SceneManager.prototype.updateScene=function(e,t){return e=this.combineSceneTexts(e),e.parsedText=parser.parseText(e.combinedText),novelData.novel.currentScene=e,t?(textPrinter.printText(e.parsedText,!0),textPrinter.complete()):novelData.novel.parsedChoices=null},SceneManager.prototype.updateChoices=function(){return novelArea.$set("novel.parsedChoices",novelData.novel.currentScene.choices.map(function(e){return e.parsedText=parser.parseText(e.text),novelArea.novel.settings.alwaysShowDisabledChoices&&(e.alwaysShow=!0),e}))},SceneManager.prototype.findSceneByName=function(e){var t,n,r,s;for(util.checkFormat(e,"string"),s=novelData.novel.scenes,n=0,r=s.length;r>n;n++)if(t=s[n],t.name===e)return t;return console.error("ERROR: Scene by name '"+e+"' not found!")},SceneManager.prototype.combineSceneTexts=function(e){var t,n,r,s;if(util.checkFormat(e,"object"),util.checkFormat(e.text,"arrayOrString"),e.combinedText="","[object Array]"===Object.prototype.toString.call(e.text))for(s=e.text,n=0,r=s.length;r>n;n++)t=s[n],e.combinedText=e.combinedText+"<p>"+t+"</p>";else e.combinedText=e.text;return e},SceneManager.prototype.readItemEdits=function(e){var t,n,r,s,a,o,i,l,u,p,c,d,v,f;if(void 0!==e.changeInventory&&(novelData.novel.currentInventory=parser.parseStatement(e.changeInventory),novelData.novel.currentInventory>novelData.novel.inventories.length))for(t=n=0,u=novelData.novel.currentInventory;u>=0?u>=n:n>=u;t=u>=0?++n:--n)void 0===novelData.novel.inventories[t]&&(novelData.novel.inventories[t]=[]);if(void 0!==e.removeItem&&inventoryManager.editItems(parser.parseItems(e.removeItem),"remove"),void 0!==e.addItem&&inventoryManager.editItems(parser.parseItems(e.addItem),"add"),void 0!==e.setItem&&inventoryManager.editItems(parser.parseItems(e.setItem),"set"),void 0!==e.setValue)for(p=e.setValue,r=0,s=p.length;s>r;r++)f=p[r],inventoryManager.setValue(f.path,parser.parseStatement(f.value.toString()));if(void 0!==e.increaseValue)for(c=e.increaseValue,i=0,a=c.length;a>i;i++)f=c[i],inventoryManager.increaseValue(f.path,parser.parseStatement(f.value.toString()));if(void 0!==e.decreaseValue){for(d=e.decreaseValue,v=[],l=0,o=d.length;o>l;l++)f=d[l],v.push(inventoryManager.decreaseValue(f.path,parser.parseStatement(f.value.toString())));return v}},SceneManager.prototype.readSounds=function(e,t){var n;return n=!1,void 0!==e.playSound&&(soundManager.playSound(parser.parseStatement(e.playSound),!1),n=!0),t&&!n&&soundManager.playDefaultClickSound(),void 0!==e.startMusic&&soundManager.startMusic(parser.parseStatement(e.startMusic)),void 0!==e.stopMusic&&soundManager.stopMusic(parser.parseStatement(e.stopMusic)),void 0!==e.scrollSound?novelData.novel.currentScene.scrollSound=parser.parseStatement(e.scrollSound):novelData.novel.settings.soundSettings.defaultScrollSound?novelData.novel.currentScene.scrollSound=novelData.novel.settings.soundSettings.defaultScrollSound:novelData.novel.currentScene.scrollSound=void 0},SceneManager.prototype.readExecutes=function(source){return void 0!==source.executeJs?eval(source.executeJs):void 0},SceneManager.prototype.readMisc=function(e){return void 0!==e.skipEnabled?novelData.novel.currentScene.skipEnabled=parser.parseStatement(e.skipEnabled):novelData.novel.currentScene.skipEnabled=novelData.novel.settings.scrollSettings.textSkipEnabled,void 0!==e.scrollSpeed?novelData.novel.currentScene.scrollSpeed=e.scrollSpeed:novelData.novel.currentScene.scrollSpeed=novelData.novel.settings.scrollSettings.defaultScrollSpeed,void 0!==e.inventoryHidden?novelData.inventoryHidden=parser.parseStatement(e.inventoryHidden):novelData.inventoryHidden=!1},SceneManager.prototype.readSaving=function(e){return void 0!==e.save&&novelManager.saveData(),void 0!==e.load?ui.showLoadNotification():void 0},SceneManager.prototype.readCheckpoints=function(e){var t,n,r,s,a,o,i,l,u,p;if(void 0!==e.saveCheckpoint){for(void 0===novelData.novel.checkpoints&&(novelData.novel.checkpoints=[]),n=!1,l=novelData.novel.checkpoints,s=0,o=l.length;o>s;s++)r=l[s],r.name===parser.parseStatement(e.saveCheckpoint)&&(r.scene=novelData.novel.currentScene.name,n=!0);n||(t={name:parser.parseStatement(e.saveCheckpoint),scene:novelData.novel.currentScene.name},novelData.novel.checkpoints.push(t))}if(void 0!==e.loadCheckpoint){for(void 0===novelData.novel.checkpoints&&(novelData.novel.checkpoints=[]),u=novelData.novel.checkpoints,p=[],a=0,i=u.length;i>a;a++)r=u[a],r.name===parser.parseStatement(e.loadCheckpoint)?p.push(this.changeScene(r.scene)):p.push(void 0);return p}},SceneManager.prototype.requirementsFilled=function(e){var t,n,r,s,a,o;for(s=[],void 0!==e.itemRequirement&&(a=parser.parseItems(e.itemRequirement),s.push(inventoryManager.checkRequirements(a))),void 0!==e.requirement&&s.push(parser.parseStatement(e.requirement)),o=!0,t=0,n=s.length;n>t;t++)r=s[t],r===!1&&(o=!1);return o},SceneManager}(),SoundManager=function(){function e(){}var t;return t=[],e.prototype.init=function(){var e,n,r,s,a,o;for(e=0,s=novelData.novel.sounds,a=[],n=0,r=s.length;r>n;n++)o=s[n],o.sound=new Audio(novelPath+"/sounds/"+o.file),t[e]=o,a.push(e++);return a},e.prototype.playDefaultClickSound=function(e,t){return this.playSound(novelData.novel.settings.soundSettings.defaultClickSound,!1)},e.prototype.playSound=function(e,t){var n,r,s,a,o;if(void 0!==e)for(e=parser.selectRandomOption(e),s=novelData.novel.sounds,n=0,r=s.length;r>n;n++)if(a=s[n],a.name===e)return o=a.sound,t?o.volume=novelData.novel.settings.soundSettings.musicVolume:o.volume=novelData.novel.settings.soundSettings.soundVolume,o.play(),o},e.prototype.isPlaying=function(e){var t,n,r,s;for(s=novelData.music,n=0,r=s.length;r>n;n++)return t=s[n],!t.paused},e.prototype.startMusic=function(e){var t,n,r,s,a;for(a=novelData.music,t=0,n=a.length;n>t;t++)if(r=a[t],r.name===e)return;return s=this.playSound(e,!0),void 0!==s?(s.addEventListener("ended",function(){this.currentTime=0,this.play()},!1),novelData.music.push({name:e,music:s})):void 0},e.prototype.stopMusic=function(e){var t,n,r,s,a,o;for(a=novelData.music,o=[],r=0,s=a.length;s>r;r++)t=a[r],e===t.name?(t.music.pause(),n=novelData.music.indexOf(t),o.push(novelData.music.splice(n,1))):o.push(void 0);return o},e}(),TextPrinter=function(){function TextPrinter(){}return TextPrinter.prototype.fullText="",TextPrinter.prototype.currentOffset=0,TextPrinter.prototype.defaultInterval=0,TextPrinter.prototype.soundBuffer=[],TextPrinter.prototype.musicBuffer=[],TextPrinter.prototype.stopMusicBuffer=[],TextPrinter.prototype.executeBuffer=[],TextPrinter.prototype.buffersExecuted=!1,TextPrinter.prototype.scrollSound=null,TextPrinter.prototype.tickSoundFrequency=1,TextPrinter.prototype.tickCounter=0,TextPrinter.prototype.tickSpeedMultiplier=1,TextPrinter.prototype.speedMod=!1,TextPrinter.prototype.pause=0,TextPrinter.prototype.interval=0,TextPrinter.prototype.printCompleted=!1,TextPrinter.prototype.printText=function(e,t){return this.printCompleted=!1,novelData.printedText="",null!==document.querySelector("#skip-button")&&(document.querySelector("#skip-button").disabled=!1),this.fullText=e,this.currentOffset=-1,this.soundBuffer=[],this.musicBuffer=[],this.stopMusicBuffer=[],this.executeBuffer=[],this.buffersExecuted=!1,t&&(this.buffersExecuted=!0),this.defaultInterval=novelData.novel.currentScene.scrollSpeed,this.setTickSoundFrequency(this.defaultInterval),setTimeout(this.onTick(),this.defaultInterval)},TextPrinter.prototype.trySkip=function(){return novelData.novel.currentScene.skipEnabled?this.complete():void 0},TextPrinter.prototype.complete=function(){var first,i,k,l,len,len1,len2,len3,o,q,ref,ref1,ref2,ref3,ref4,ref5,ref6,ref7,s,ss,t,u,v,w;if(this.printCompleted=!0,this.currentOffset=0,null!==document.querySelector("#skip-button")&&(document.querySelector("#skip-button").disabled=!0),!this.buffersExecuted){if(ss=[],first=!0,this.fullText.indexOf("play-sound")>-1)for(s=this.fullText.split("play-sound "),k=0,len=s.length;len>k;k++)i=s[k],first||ss.push(i.split(/\s|\"/)[0]),first=!1;if(ss.length>0)for(i=l=0,ref=ss.length;ref>=0?ref>=l:l>=ref;i=ref>=0?++l:--l)ref1=ss[i],indexOf.call(this.soundBuffer,ref1)>=0||soundManager.playSound(parser.parseStatement(ss[i]));if(ss=[],first=!0,this.fullText.indexOf("play-music")>-1)for(s=this.fullText.split("play-music "),o=0,len1=s.length;len1>o;o++)i=s[o],first||ss.push(i.split(/\s|\"/)[0]),first=!1;if(ss.length>0)for(i=q=0,ref2=ss.length;ref2>=0?ref2>=q:q>=ref2;i=ref2>=0?++q:--q)ref3=ss[i],indexOf.call(this.musicBuffer,ref3)>=0||soundManager.startMusic(parser.parseStatement(ss[i]));if(ss=[],first=!0,this.fullText.indexOf("stop-music")>-1)for(s=this.fullText.split("stop-music "),t=0,len2=s.length;len2>t;t++)i=s[t],first||ss.push(i.split(/\s|\"/)[0]),first=!1;if(ss.length>0)for(i=u=0,ref4=ss.length;ref4>=0?ref4>=u:u>=ref4;i=ref4>=0?++u:--u)ref5=ss[i],indexOf.call(this.stopMusicBuffer,ref5)>=0||soundManager.stopMusic(parser.parseStatement(ss[i]));if(ss=[],first=!0,this.fullText.indexOf("execute-command")>-1)for(s=this.fullText.split("execute-command "),v=0,len3=s.length;len3>v;v++)i=s[v],first||ss.push(i.split(/\s|\"/)[0]),first=!1;if(ss.length>0)for(i=w=0,ref6=ss.length;ref6>=0?ref6>=w:w>=ref6;i=ref6>=0?++w:--w)ref7=ss[i],indexOf.call(this.executeBuffer,ref7)>=0||void 0===ss[i]||eval(novelData.parsedJavascriptCommands[parseInt(s.substring(4,s.length))]);this.buffersExecuted=!0}return novelData.printedText=this.fullText,sceneManager.updateChoices()},TextPrinter.prototype.unpause=function(){return null!==document.querySelector("#continue-button")&&(document.querySelector("#continue-button").style.display="none"),"input"===this.pause?this.pause=0:void 0},TextPrinter.prototype.fastScroll=function(){return novelData.novel.currentScene.skipEnabled?this.tickSpeedMultiplier=novelData.novel.settings.scrollSettings.fastScrollSpeedMultiplier:void 0},TextPrinter.prototype.stopFastScroll=function(){return this.tickSpeedMultiplier=1},TextPrinter.prototype.setTickSoundFrequency=function(e){var t;return t=novelData.novel.settings.scrollSettings.tickFreqThreshold,this.tickSoundFrequency=1,2*t>=e&&(this.tickSoundFrequency=2),t>=e?this.tickSoundFrequency=3:void 0},TextPrinter.prototype.onTick=function(){var e;if("input"!==this.pause&&this.pause>0&&this.pause--,0===this.pause){if(this.speedMod||(this.interval=this.defaultInterval),0===this.defaultInterval)return void this.complete();if(novelData.printedText===this.fullText)return;for(e=!1;" "===this.fullText[this.currentOffset]||"<"===this.fullText[this.currentOffset]||">"===this.fullText[this.currentOffset];)this.readTags();if(novelData.printedText=this.fullText.substring(0,this.currentOffset),e||this.currentOffset++,this.currentOffset>=this.fullText.length)return void this.complete();this.tickCounter++,this.tickCounter>=this.tickSoundFrequency&&"none"!==this.scrollSound&&0!==this.interval&&(null!==this.scrollSound?soundManager.playSound(this.scrollSound):void 0!==novelData.novel.currentScene.scrollSound&&soundManager.playSound(novelData.novel.currentScene.scrollSound),this.tickCounter=0)}return this.setTickSoundFrequency(this.interval/this.tickSpeedMultiplier),setTimeout(function(){textPrinter.onTick()},this.interval/this.tickSpeedMultiplier)},TextPrinter.prototype.readTags=function(){var disp,i,s,spans,str;if(" "===this.fullText[this.currentOffset]&&this.currentOffset++,">"===this.fullText[this.currentOffset]&&this.currentOffset++,"<"===this.fullText[this.currentOffset]){for(i=this.currentOffset,str="",i++;">"!==this.fullText[i-1]&&"<"!==this.fullText[i];)str+=this.fullText[i],i++;if(str=str.substring(1,str.length),str.indexOf("display:none;")>-1){for(disp="",spans=1;;)if(i++,disp+=this.fullText[i],-1!==disp.indexOf("/span")?(spans--,disp=""):-1!==disp.indexOf("span")&&(spans++,disp=""),0===spans)break;i++}return str.indexOf("play-sound")>-1&&str.indexOf("display:none;")>-1&&(s=str.split("play-sound "),s=s[1].split(/\s|\"/)[0],this.soundBuffer.push(parser.parseStatement(s))),str.indexOf("play-music")>-1&&str.indexOf("display:none;")>-1&&(s=str.split("play-music "),s=s[1].split(/\s|\"/)[0],this.musicBuffer.push(parser.parseStatement(s))),str.indexOf("stop-music")>-1&&str.indexOf("display:none;")>-1&&(s=str.split("stop-music "),s=s[1].split(/\s|\"/)[0],this.stopMusicBuffer.push(parser.parseStatement(s))),str.indexOf("execute-command")>-1&&str.indexOf("display:none;")>-1&&(s=str.split("execute-command "),s=s[1].split(/\s|\"/)[0],this.executeBuffer.push(parser.parseStatement(s))),-1===str.indexOf("display:none;")&&(str.indexOf("play-sound")>-1&&(s=str.split("play-sound "),s=s[1].split(/\s|\"/)[0],this.soundBuffer.push(parser.parseStatement(s)),soundManager.playSound(parser.parseStatement(s))),str.indexOf("play-music")>-1&&(s=str.split("play-music "),s=s[1].split(/\s|\"/)[0],this.musicBuffer.push(parser.parseStatement(s)),soundManager.startMusic(parser.parseStatement(s))),str.indexOf("stop-music")>-1&&(s=str.split("stop-music "),s=s[1].split(/\s|\"/)[0],this.stopMusicBuffer.push(parser.parseStatement(s)),soundManager.stopMusic(parser.parseStatement(s))),str.indexOf("pause")>-1&&(s=str.split("pause "),s=s[1].split(/\s|\"/)[0],this.pause=s,"input"===this.pause&&null!==document.querySelector("#continue-button")&&(document.querySelector("#continue-button").style.display="inline")),str.indexOf("execute-command")>-1&&(s=str.split("execute-command "),s=s[1].split(/\s|\"/)[0],this.executeBuffer.push(s),void 0!==s&&eval(novelData.parsedJavascriptCommands[parseInt(s.substring(4,s.length))])),str.indexOf("set-speed")>-1&&(s=str.split("set-speed "),s=s[1].split(/\s|\"/)[0],this.interval=parser.parseStatement(s),this.speedMod=!0),str.indexOf("default-speed")>-1&&(this.interval=this.defaultInterval,this.speedMod=!1),str.indexOf("set-scroll-sound")>-1&&(s=str.split("set-scroll-sound "),s=s[1].split(/\s|\"/)[0],this.scrollSound=parser.parseStatement(s)),str.indexOf("default-scroll-sound")>-1&&(this.scrollSound=null)),this.currentOffset=i,this.offsetChanged=!0}},TextPrinter}(),UI=function(){function e(){}return e.prototype.showSaveNotification=function(e){var t,n;return t=document.getElementById("save-notification"),n=t.querySelectorAll("textarea"),n[0].value=e,t.style.display="block"},e.prototype.closeSaveNotification=function(){var e;return e=document.getElementById("save-notification"),e.style.display="none"},e.prototype.showLoadNotification=function(){var e;return"text"===novelArea.novel.settings.saveMode?(e=document.getElementById("load-notification"),e.style.display="block"):novelManager.loadGame()},e.prototype.closeLoadNotification=function(e,t){var n,r;return n=document.getElementById("load-notification"),e&&(r=n.querySelectorAll("textarea"),novelManager.loadData(r[0].value,t),r[0].value=""),n.style.display="none"},e.prototype.updateInputs=function(e){var t,n,r,s,a,o;for(r=document.getElementById("novel-area").querySelectorAll("input"),o=[],s=0,a=r.length;a>s;s++)n=r[s],o.push(function(){var r,s,a,o;for(a=novelData.novel.inventories[novelData.novel.currentInventory],o=[],r=0,s=a.length;s>r;r++)t=a[r],t.name===n.className.substring(6,n.className.length)?(t.value=util.stripHTML(n.value),e?o.push(sceneManager.updateScene(novelData.novel.currentScene,!0)):o.push(void 0)):o.push(void 0);return o}());return o},e}(),copyButton=document.querySelector("#copy-button"),null!==copyButton&&copyButton.addEventListener("click",function(e){var t,n,r,s;t=document.getElementById("save-notification").querySelector("textarea"),t.select();try{s=document.execCommand("copy")}catch(r){n=r,console.error("Copying to clipboard failed: "+n)}}),Util=function(){function e(){}return e.prototype.isEven=function(e){return e%2===0},e.prototype.isOdd=function(e){return 1===Math.abs(e%2)},e.prototype.stripHTML=function(e){var t;return t=/(<([^>]+)>)/gi,e.replace(t,"")},e.prototype.checkFormat=function(e,t){return"array"===t?"[object Array]"===Object.prototype.toString.call(e)?!0:(console.error("ERROR: Invalid input format (should be "+t+")"),!1):"arrayOrString"===t?"[object Array]"===Object.prototype.toString.call(e)||"string"==typeof e?!0:(console.error("ERROR: Invalid input format in (should be "+t+")"),!1):typeof e===t?!0:(console.error("ERROR: Invalid input format in (should be "+t+")"),!1)},e.prototype.validateParentheses=function(e){var t,n,r,s;for(s=0,n=0,r=e.length;r>n;n++)if(t=e[n],"("===t&&s++,")"===t){if(!(s>0))return!1;s--}return 0===s},e}(),novelData={novel:null,choices:null,debugMode:!1,inventoryHidden:!1,printedText:"",parsedJavascriptCommands:[],music:[]},novelPath="./novel",novelManager=new NovelManager,inputManager=new InputManager,inventoryManager=new InventoryManager,parser=new Parser,sceneManager=new SceneManager,soundManager=new SoundManager,textPrinter=new TextPrinter,ui=new UI,util=new Util,novelArea=new Vue({el:"#novel-area",data:novelData,methods:{requirementsFilled:function(e){return sceneManager.requirementsFilled(e)},textSkipEnabled:function(e){return novelData.novel.currentScene.skipEnabled&&novelData.novel.settings.skipButtonShown},itemsOverZeroAndAreHidden:function(e){
var t,n,r,s;for(s=novelData.novel.inventories[novelData.novel.currentInventory],n=0,r=s.length;r>n;n++)if(t=s[n],t.name===e.name&&t.hidden&&void 0!==t.hidden){if(t.value>0)return!0;if(isNaN(t.value))return!0}return!1},itemsOverZeroAndNotHidden:function(e){var t,n,r,s;for(s=novelData.novel.inventories[novelData.novel.currentInventory],n=0,r=s.length;r>n;n++)if(t=s[n],t.name===e.name&&(!t.hidden||void 0===t.hidden)){if(t.value>0)return!0;if(isNaN(t.value))return!0}return!1},itemsOverZeroAndHidden:function(e){return inventoryManager.itemsOverZero(e)&&inventoryManager.itemHidden(e)},selectChoice:function(e){return sceneManager.selectChoice(e)}}}),novelManager.start();